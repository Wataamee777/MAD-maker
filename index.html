<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MAD Frequency MIDI Tool</title>
<script src="https://unpkg.com/@tonejs/midi/build/Midi.js"></script>
<style>
  body { font-family: sans-serif; background:#111; color:#eee; padding:20px }
  button { padding:8px 14px; margin-top:10px }
</style>
</head>
<body>

<h2>MAD 周波数帯 MIDI ツール（フル版）</h2>

<div>
  音源: <input type="file" id="audio" accept="audio/*">
</div>
<div>
  MIDI: <input type="file" id="midi" accept=".mid">
</div>

<button id="render">WAV 書き出し</button>
<a id="download"></a>

<script>
let audioBuffer, midi;

/* ========= 基本関数 ========= */

// MIDI → 周波数（A4=440Hz）
function midiToFreq(n) {
  return 440 * Math.pow(2, (n - 69) / 12);
}

// 音階 → 周波数帯（MAD用）
function noteToBand(midi, width = 0.25) {
  const f = midiToFreq(midi);
  return [f * (1 - width), f * (1 + width)];
}

// AudioBuffer → WAV
function bufferToWav(buffer) {
  const ch = buffer.numberOfChannels;
  const len = buffer.length * ch * 2 + 44;
  const view = new DataView(new ArrayBuffer(len));
  let pos = 0;

  function writeU16(v){ view.setUint16(pos,v,true); pos+=2 }
  function writeU32(v){ view.setUint32(pos,v,true); pos+=4 }

  view.setUint32(pos,0x46464952,false); pos+=4;
  writeU32(len-8);
  view.setUint32(pos,0x45564157,false); pos+=4;
  view.setUint32(pos,0x20746d66,false); pos+=4;
  writeU32(16); writeU16(1); writeU16(ch);
  writeU32(buffer.sampleRate);
  writeU32(buffer.sampleRate * ch * 2);
  writeU16(ch * 2); writeU16(16);
  view.setUint32(pos,0x61746164,false); pos+=4;
  writeU32(len-pos-4);

  for(let i=0;i<buffer.length;i++){
    for(let c=0;c<ch;c++){
      let s = buffer.getChannelData(c)[i];
      s = Math.max(-1,Math.min(1,s));
      view.setInt16(pos, s<0?s*0x8000:s*0x7fff, true);
      pos+=2;
    }
  }
  return new Blob([view], {type:"audio/wav"});
}

/* ========= 読み込み ========= */

audio.onchange = async e => {
  const buf = await e.target.files[0].arrayBuffer();
  const ctx = new AudioContext();
  audioBuffer = await ctx.decodeAudioData(buf);
  alert("音源OK");
};

midiInput.onchange = async e => {
  const buf = await e.target.files[0].arrayBuffer();
  midi = new Midi(buf);
  alert("MIDI OK");
};

/* ========= 書き出し ========= */

render.onclick = async () => {
  if (!audioBuffer || !midi) {
    alert("音源とMIDIを入れて");
    return;
  }

  const duration = midi.duration + 1;
  const rate = audioBuffer.sampleRate;

  const offline = new OfflineAudioContext(
    audioBuffer.numberOfChannels,
    rate * duration,
    rate
  );

  midi.tracks.forEach(track => {
    track.notes.forEach(note => {
      const src = offline.createBufferSource();
      src.buffer = audioBuffer;

      const [low, high] = noteToBand(note.midi);

      const hp = offline.createBiquadFilter();
      hp.type = "highpass";
      hp.frequency.value = low;

      const lp = offline.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = high;

      const gain = offline.createGain();
      gain.gain.value = note.velocity;

      src.connect(hp);
      hp.connect(lp);
      lp.connect(gain);
      gain.connect(offline.destination);

      src.start(note.time, 0, 0.06); // ← MAD刻み
    });
  });

  const rendered = await offline.startRendering();
  const wav = bufferToWav(rendered);

  const url = URL.createObjectURL(wav);
  download.href = url;
  download.download = "mad.wav";
  download.textContent = "⬇ WAV ダウンロード";
};
</script>
</body>
</html>
